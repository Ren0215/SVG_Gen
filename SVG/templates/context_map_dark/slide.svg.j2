{% macro lines(txt, limit=24) -%}
  {%- set t = txt|truncate(limit, end='…') -%}
  {%- set cols = 12 -%} {# ≒ 2 全角 × 6 #}
  {%- set wrapped = t|wordwrap(cols, break_long_words=true) -%}
  {%- for l in wrapped.split('\n')[:3] -%}
    <tspan x="{{ cx }}" dy="{{ loop.first and '-12' or '14' }}">{{ l }}</tspan>
  {%- endfor -%}
{%- endmacro %}

{% set P = palette_colors %}{% set C = content %}
<svg width="1280" height="720" viewBox="0 0 1280 720"
     xmlns="http://www.w3.org/2000/svg" text-rendering="optimizeLegibility">

  <rect width="1280" height="720" fill="{{ P.bg }}" />
  <text x="41"  y="692" font-size="7" font-family="Arial" fill="{{ P.footer }}">
    CONFIDENTIAL {{ C.company }}. All rights reserved
  </text>
  <text x="33"  y="53" font-size="20" font-weight="700" font-family="Arial"
        fill="{{ P.title }}">{{ C.company }} コンテキストマップ</text>

  <circle cx="640" cy="351" r="55" fill="{{ P.center }}" />
  <text   x="640" y="351" text-anchor="middle" dominant-baseline="middle"
          font-size="11" font-family="Arial" fill="#fff">{{ C.center }}</text>

  {# ------------ label bars ------------ #}
  {% for label,x,y in [
      ("企業戦略文脈",401,249), ("プロダクト文脈",291,338),
      ("TOP文脈",383,446),     ("業界トレンド文脈",736,446),
      ("社会トレンド文脈",848,338), ("グローバル文脈",736,249)] %}
    <rect x="{{ x }}" y="{{ y }}" width="161" height="25" fill="{{ P.label }}" />
    <text x="{{ x+10 }}" y="{{ y+17 }}" font-size="11" font-weight="700"
          font-family="Arial" fill="#fff">{{ label }}</text>
  {% endfor %}

  {# ------------ node coordinates ------------ #}
  {% set coords = {
    'strategy':  [(263,145),(408,145),(188,217),(333,217),(478,217)],
    'product':   [(70,297),(215,297),(140,363),(70,432),(215,432)],
    'top':       [(263,513),(408,513),(188,582),(333,582),(478,582)],
    'industry':  [(730,513),(875,513),(660,582),(805,582),(950,582)],
    'society':   [(972,297),(1117,297),(1042,363),(972,432),(1117,432)],
    'global':    [(730,145),(875,145),(660,217),(805,217),(950,217)]
  } %}

  {# ------------ draw nodes ------------ #}
  {% for cat,nodes in coords.items() %}
    {% for idx,(cx,cy) in enumerate(nodes) %}
      {% if idx < C[cat]|length %}
        <circle cx="{{ cx }}" cy="{{ cy }}" r="34" fill="{{ P.node }}" />
        <text x="{{ cx }}" y="{{ cy }}" text-anchor="middle"
              font-size="10" font-family="Arial" fill="#fff"
              dominant-baseline="middle">{{ lines(C[cat][idx]) }}</text>
      {% endif %}
    {% endfor %}
  {% endfor %}
</svg>
